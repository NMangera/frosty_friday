-- CREATE EXTERNAL STAGE THAT POINTS TO AN S3 BUCKET
CREATE OR REPLACE STAGE week55_stage
    URL='s3://frostyfridaychallenges/challenge_55/';

-- VIEW ALL OF THE FILES IN THE STAGE
LIST @week55_stage;

-- CREATE A FILE FORMAT TO INGEST CONTENTS AS A SINGLE FIELD (EXPLORATION)
CREATE OR REPLACE FILE FORMAT ff_single_field
    TYPE = CSV
    FIELD_DELIMITER = NONE
    RECORD_DELIMITER = '\n'
    SKIP_HEADER = 0 ;

-- QUERY THE DATA IN THE STAGE USING THE ff_single_field FILE FORMAT
SELECT
    METADATA$FILENAME::STRING AS FILE_NAME  -- EXTRACT THE FILE NAME FROM METADATA
  , METADATA$FILE_ROW_NUMBER AS ROW_NUMBER  -- GET THE ROW NUMBER FROM METADATA
  , $1::VARIANT AS CONTENTS  -- EXTRACT THE FIRST COLUMN'S CONTENT
FROM @WEEK55_STAGE
  (FILE_FORMAT => 'FF_SINGLE_FIELD')
ORDER BY
    FILE_NAME
  , ROW_NUMBER
;

-- CREATE A NEW FILE FORMAT THAT MATCHES THE INCOMING FILE STRUCTURE
CREATE OR REPLACE FILE FORMAT ff_csv_ingestion
    TYPE = CSV
    FIELD_DELIMITER = ','
    RECORD_DELIMITER = '\n'
    SKIP_HEADER = 1;

-- CREATE A TABLE TO STORE THE INGESTED DATA (USING THE STRUCTURE EXPLORED EARLIER)
CREATE OR REPLACE TABLE raw_data (
  SALE_ID INT
  , PRODUCT STRING
  , QUANTITY INT
  , SALE_DATE DATE
  , PRICE FLOAT
  , COUNTRY STRING
  , CITY STRING
);

-- MOVE DATA FROM THE STAGE TO THE SNOWFLAKE TABLE
COPY INTO raw_data FROM @week55_stage
FILE_FORMAT = (FORMAT_NAME = 'ff_csv_ingestion');

--QUERY THE DATA
SELECT * FROM raw_data;

-- IDENTIFY DUPLICATE RECORDS (PRIOR TO QUALIFY)
SELECT COUNT(*) FROM raw_data
GROUP BY SALE_ID
HAVING COUNT(SALE_ID) > 1
order by SALE_ID;

-- IDENTIFY DUPLICATE RECORDS
SELECT *
FROM raw_data
QUALIFY COUNT(*) OVER (PARTITION BY SALE_ID) > 1
ORDER BY SALE_ID;

-- QUERY THE DATA AND PRESENT TO MATCH EXPECTED OUTPUT (RENAME COLUMNS AND ARRANGE)
SELECT SALE_ID AS INDEX, PRODUCT, QUANTITY, SALE_DATE AS DATA, PRICE, COUNTRY, CITY FROM raw_data
GROUP BY ALL
ORDER BY SALE_ID DESC;
